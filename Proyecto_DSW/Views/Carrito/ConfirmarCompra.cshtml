@model Proyecto_DSW.Models.DTO.ConfirmarCompraVista
@using Proyecto_DSW.Models
@using Newtonsoft.Json
@using Microsoft.AspNetCore.Mvc.Rendering
@using Proyecto_DSW.Models.DTO

@{
    ViewData["Title"] = "Confirmar Compra";
    decimal total = 0;
}

<h2>🛒 Confirmar Compra</h2>

@if (!Model.Detalles.Any())
{
    <p>Tu carrito está vacío.</p>
    <a asp-action="Index" asp-controller="Carrito" class="btn btn-primary mt-2">Volver al carrito</a>
}
else
{
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Imagen</th>
                <th>Título</th>
                <th>Autor</th>
                <th>Precio</th>
                <th>Cantidad</th>
                <th>Subtotal</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model.Detalles)
            {
                var subtotal = item.Libro.precio * item.Cantidad;
                total += subtotal;
                <tr>
                    <td>
                        <img src="~/img/@item.Libro.imagen" alt="@item.Libro.titulo" style="width:80px; height:auto;" />
                    </td>
                    <td>@item.Libro.titulo</td>
                    <td>@item.Libro.autor</td>
                    <td>S/. @item.Libro.precio</td>
                    <td>@item.Cantidad</td>
                    <td>S/. @subtotal</td>
                </tr>
            }
        </tbody>
        <tfoot>
            <tr>
                <td colspan="5" class="text-end"><strong>Total:</strong></td>
                <td><strong>S/. @total</strong></td>
            </tr>
        </tfoot>
    </table>

    <form asp-controller="Venta" asp-action="Crear" method="post">
        <input type="hidden" name="idUsuario" value="@Model.IdUsuario" />

        <label for="IdMetodoPago" class="form-label">Método de Pago:</label>
        <select name="idMetodoPago" id="IdMetodoPago" class="form-select mb-3">
            <option value="">-- Selecciona un método de pago --</option>
            @foreach (SelectListItem metodo in ViewBag.MetodosDePago)
            {
                <option value="@metodo.Value">@metodo.Text</option>
            }
        </select>

        <input type="hidden"
               name="detalles"
               value='@JsonConvert.SerializeObject(
                                                              Model.Detalles.Select(x => new DetalleVentaRequest { IdLibro = x.IdLibro, Cantidad = x.Cantidad })
                                                          )' />

    <button type="submit" class="btn btn-success">Confirmar Compra</button>
    <a asp-action="Index" asp-controller="Carrito" class="btn btn-secondary ms-2">Cancelar</a>
</form>
}
